<script>
/* ============================================
   DASHBOARD - FILTRO Y DATOS
   ============================================ */

const DashboardFilter = {
  
  selectedMonth: null,
  tiendaId: null,
  
  monthNames: {
    1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril',
    5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto',
    9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'
  },
  
  monthShort: {
    1: 'Ene', 2: 'Feb', 3: 'Mar', 4: 'Abr',
    5: 'May', 6: 'Jun', 7: 'Jul', 8: 'Ago',
    9: 'Sep', 10: 'Oct', 11: 'Nov', 12: 'Dic'
  },
  
  init() {
    const userData = JSON.parse(sessionStorage.getItem('userData'));
    if (userData && userData.tienda) {
      this.getTiendaId(userData.tienda);
    }
    
    const currentMonth = new Date().getMonth() + 1;
    const currentMonthBtn = document.querySelector(`[data-month="${currentMonth}"]`);
    if (currentMonthBtn) {
      this.selectMonth(currentMonth, currentMonthBtn);
    }
  },
  
  getTiendaId(nombreTienda) {
    google.script.run
      .withSuccessHandler((id) => {
        this.tiendaId = id;
        
        if (this.selectedMonth) {
          this.loadMonthData(this.selectedMonth);
        }
        
        this.loadYesterdayData();
        DashboardHistory.init(id);
        DashboardWeekly.init(id);
        DashboardBrand.init(id);
      })
      .withFailureHandler((error) => {
        console.error('[Dashboard] Error:', error);
      })
      .getTiendaId(nombreTienda);
  },
  
  selectMonth(monthNumber, btnElement) {
    this.selectedMonth = monthNumber;
    
    document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
    btnElement.classList.add('active');
    
    document.getElementById('selectedMonthIndicator').style.display = 'block';
    document.getElementById('selectedMonthValue').textContent = this.monthNames[monthNumber];
    
    this.loadMonthData(monthNumber);
  },
  
  loadMonthData(monthNumber) {
    if (!this.tiendaId) return;
    
    this.setCardLoading('victoryCard', true);
    this.setCardLoading('commissionCurrentCard', true);
    this.setCardLoading('kpiCard', true);
    
    google.script.run
      .withSuccessHandler((data) => { this.renderMonthData(data); })
      .withFailureHandler(() => {
        this.setCardLoading('victoryCard', false);
        this.setCardLoading('commissionCurrentCard', false);
        this.setCardLoading('kpiCard', false);
      })
      .consultarDatosMes(this.tiendaId, monthNumber);
  },
  
  loadYesterdayData() {
    if (!this.tiendaId) return;
    
    this.setCardLoading('yesterdayCard', true);
    
    google.script.run
      .withSuccessHandler((data) => { this.renderYesterdayData(data); })
      .withFailureHandler(() => { this.setCardLoading('yesterdayCard', false); })
      .consultarDatosAyer(this.tiendaId);
  },
  
  renderMonthData(data) {
    if (!data) {
      document.getElementById('victoryAmount').textContent = '$0';
      document.getElementById('commissionCurrentAmount').textContent = '$0';
      document.getElementById('kpiMeta').textContent = '$0';
      document.getElementById('kpiVenta').textContent = '$0';
      document.getElementById('kpiDiff').textContent = '$0';
      this.setCardLoading('victoryCard', false);
      this.setCardLoading('commissionCurrentCard', false);
      this.setCardLoading('kpiCard', false);
      return;
    }
    
    const objetivoComision = parseFloat(data.Objetivo_Comision) || 0;
    this.animateNumber('victoryAmount', objetivoComision);
    this.setCardLoading('victoryCard', false);
    
    const comisionActual = parseFloat(data.Comision_Acum) || 0;
    document.getElementById('commissionCurrentAmount').textContent = this.formatMoney(comisionActual);
    this.setCardLoading('commissionCurrentCard', false);
    
    const meta = parseFloat(data.Meta) || 0;
    const venta = parseFloat(data.A) || 0;
    const metaDif = parseFloat(data.Meta_dif) || 0;
    
    document.getElementById('kpiMeta').textContent = this.formatMoney(meta);
    document.getElementById('kpiVenta').textContent = this.formatMoney(venta);
    document.getElementById('kpiDiff').textContent = this.formatMoney(Math.abs(metaDif));
    
    const kpiDiffContainer = document.getElementById('kpiDiffContainer');
    const kpiDiffLabel = document.getElementById('kpiDiffLabel');
    kpiDiffContainer.classList.remove('positive', 'negative');
    
    if (metaDif < 0) {
      kpiDiffLabel.textContent = 'Deuda';
      kpiDiffContainer.classList.add('negative');
    } else {
      kpiDiffLabel.textContent = 'A Favor';
      kpiDiffContainer.classList.add('positive');
    }
    
    this.setCardLoading('kpiCard', false);
  },
  
  renderYesterdayData(data) {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    document.getElementById('yesterdayDate').textContent = yesterday.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' });
    
    if (!data) {
      document.getElementById('yesterdayMeta').textContent = '$0';
      document.getElementById('yesterdayVenta').textContent = '$0';
      document.getElementById('yesterdayDiff').textContent = '$0';
      document.getElementById('yesterdayPctMeta').textContent = '0%';
      this.setCardLoading('yesterdayCard', false);
      return;
    }
    
    document.getElementById('yesterdayMeta').textContent = this.formatMoney(parseFloat(data.Meta) || 0);
    document.getElementById('yesterdayVenta').textContent = this.formatMoney(parseFloat(data.A) || 0);
    document.getElementById('yesterdayDiff').textContent = this.formatMoney(Math.abs(parseFloat(data.Meta_dif) || 0));
    document.getElementById('yesterdayPctMeta').textContent = this.formatPercent(parseFloat(data.Crec_vs_Meta) || 0);
    
    const metaDif = parseFloat(data.Meta_dif) || 0;
    const diffContainer = document.getElementById('yesterdayDiffContainer');
    const diffLabel = document.getElementById('yesterdayDiffLabel');
    diffContainer.classList.remove('positive', 'negative');
    
    if (metaDif < 0) {
      diffLabel.textContent = 'Deuda';
      diffContainer.classList.add('negative');
    } else {
      diffLabel.textContent = 'A Favor';
      diffContainer.classList.add('positive');
    }
    
    this.setCardLoading('yesterdayCard', false);
  },
  
  formatMoney(value) {
    return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
  },
  
  formatPercent(value) {
    return Math.round(value * 100) + '%';
  },
  
  animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    const duration = 1000;
    const startTime = performance.now();
    
    const animate = (currentTime) => {
      const progress = Math.min((currentTime - startTime) / duration, 1);
      const easeProgress = 1 - Math.pow(2, -10 * progress);
      element.textContent = this.formatMoney(targetValue * easeProgress);
      if (progress < 1) requestAnimationFrame(animate);
    };
    
    requestAnimationFrame(animate);
  },
  
  setCardLoading(cardId, isLoading) {
    const card = document.getElementById(cardId);
    if (card) card.classList.toggle('loading', isLoading);
  }
};

/* ============================================
   DASHBOARD - HISTORIAL
   ============================================ */

const DashboardHistory = {
  
  data: [],
  currentPage: 0,
  rowsPerPage: 9,
  
  init(tiendaId) {
    document.getElementById('historyCard').classList.add('loading');
    
    google.script.run
      .withSuccessHandler((data) => {
        this.data = data || [];
        this.findTodayPage();
        this.render();
        document.getElementById('historyCard').classList.remove('loading');
      })
      .withFailureHandler(() => {
        document.getElementById('historyCard').classList.remove('loading');
      })
      .consultarHistorial(tiendaId);
  },
  
  findTodayPage() {
    const today = new Date().toISOString().split('T')[0];
    for (let i = 0; i < this.data.length; i++) {
      const rowDate = this.data[i].Fecha.value || this.data[i].Fecha;
      if (rowDate === today) {
        this.currentPage = Math.floor(i / this.rowsPerPage);
        break;
      }
    }
  },
  
  render() {
    const tbody = document.getElementById('historyTableBody');
    const start = this.currentPage * this.rowsPerPage;
    const pageData = this.data.slice(start, start + this.rowsPerPage);
    const today = new Date().toISOString().split('T')[0];
    
    if (pageData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9">No hay datos</td></tr>';
      return;
    }
    
    tbody.innerHTML = pageData.map(row => {
      const fecha = row.Fecha.value || row.Fecha;
      const aaDif = parseFloat(row.AA_dif) || 0;
      const metaDif = parseFloat(row.Meta_dif) || 0;
      
      let rowClass = '';
      if (fecha === today) rowClass = 'row-today';
      else if (fecha > today) rowClass = 'row-future';
      else if (metaDif < 0) rowClass = 'row-meta-negative';
      else if (aaDif < 0) rowClass = 'row-aa-negative';
      
      const fechaFormatted = new Date(fecha + 'T00:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
      
      return `<tr class="${rowClass}">
        <td class="col-fecha">${fechaFormatted}</td>
        <td class="col-dia">${row.Dia || ''}</td>
        <td>${this.formatNum(row.A)}</td>
        <td>${this.formatNum(row.AA)}</td>
        <td>${this.formatNum(row.AA_dif)}</td>
        <td>${this.formatPct(row.Crec_vs_AA)}</td>
        <td class="col-meta-group">${this.formatNum(row.Meta)}</td>
        <td class="col-meta-group">${this.formatNum(row.Meta_dif)}</td>
        <td class="col-meta-group">${this.formatPct(row.Crec_vs_Meta)}</td>
      </tr>`;
    }).join('');
    
    this.updateNav();
  },
  
  updateNav() {
    const totalPages = Math.ceil(this.data.length / this.rowsPerPage);
    document.getElementById('historyPrevBtn').disabled = this.currentPage === 0;
    document.getElementById('historyNextBtn').disabled = this.currentPage >= totalPages - 1;
    document.getElementById('historyPageIndicator').textContent = `Página ${this.currentPage + 1} de ${totalPages}`;
  },
  
  prevPage() { if (this.currentPage > 0) { this.currentPage--; this.render(); } },
  nextPage() { if (this.currentPage < Math.ceil(this.data.length / this.rowsPerPage) - 1) { this.currentPage++; this.render(); } },
  
  formatNum(v) { return new Intl.NumberFormat('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(parseFloat(v) || 0); },
  formatPct(v) { return Math.round((parseFloat(v) || 0) * 100) + '%'; }
};

/* ============================================
   DASHBOARD - SEMANAL
   ============================================ */

const DashboardWeekly = {
  
  data: [],
  mode: 'minimo',
  
  init(tiendaId) {
    document.getElementById('weeklyCard').classList.add('loading');
    
    google.script.run
      .withSuccessHandler((data) => {
        this.data = data || [];
        this.render();
        document.getElementById('weeklyCard').classList.remove('loading');
      })
      .withFailureHandler(() => {
        document.getElementById('weeklyCard').classList.remove('loading');
      })
      .consultarSemanal(tiendaId);
  },
  
  setMode(mode) {
    this.mode = mode;
    document.getElementById('weeklyToggleMin').classList.toggle('active', mode === 'minimo');
    document.getElementById('weeklyToggleMeta').classList.toggle('active', mode === 'meta');
    this.render();
  },
  
  render() {
    const container = document.getElementById('weeklyCircles');
    
    container.innerHTML = Array.from({ length: 10 }, (_, i) => {
      const weekData = this.data[i];
      
      if (weekData) {
        const semana = parseInt(weekData.Semana) || 0;
        const value = this.mode === 'minimo' ? parseFloat(weekData.Crec_vs_AA) || 0 : parseFloat(weekData.Crec_vs_Meta) || 0;
        const circleClass = value >= 0 ? 'positive' : 'negative';
        
        return `<div class="weekly-item">
          <div class="weekly-circle ${circleClass}">${Math.round(value * 100)}%</div>
          <div class="weekly-number">${semana}</div>
        </div>`;
      }
      
      return `<div class="weekly-item">
        <div class="weekly-circle empty">-</div>
        <div class="weekly-number">-</div>
      </div>`;
    }).join('');
  }
};


/* ============================================
   DASHBOARD - TU MARCA PERSONAL
   ============================================ */

const DashboardBrand = {
  
  data: [],
  currentPage: 0,
  rowsPerPage: 6,
  
  init(tiendaId) {
    document.getElementById('brandCard').classList.add('loading');
    
    google.script.run
      .withSuccessHandler((data) => {
        this.data = data || [];
        this.render();
        document.getElementById('brandCard').classList.remove('loading');
      })
      .withFailureHandler(() => {
        document.getElementById('brandCard').classList.remove('loading');
      })
      .consultarMarcaPersonal(tiendaId);
  },
  
  render() {
    const tbody = document.getElementById('brandTableBody');
    const start = this.currentPage * this.rowsPerPage;
    const pageData = this.data.slice(start, start + this.rowsPerPage);
    
    const monthShort = { 1: 'Ene', 2: 'Feb', 3: 'Mar', 4: 'Abr', 5: 'May', 6: 'Jun', 7: 'Jul', 8: 'Ago', 9: 'Sep', 10: 'Oct', 11: 'Nov', 12: 'Dic' };
    
    if (pageData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">No hay datos</td></tr>';
      return;
    }
    
    tbody.innerHTML = pageData.map(row => {
      const mes = parseInt(row.Mes) || 1;
      const quincena = parseInt(row.Quincena) || 1;
      const tipoComision = parseFloat(row.Tipo_Comision) || 0;
      const gemaSencilla = parseInt(row.GemasSencilla) || 0;
      const gemaDoble = parseInt(row.GemasDoble) || 0;
      
      const periodo = `${monthShort[mes]} Q${quincena}`;
      
      // Icono: estrella en círculo negro o palomita verde
      let icon = '';
      if (gemaDoble === 1) {
        icon = '<span class="icon-star">⭐</span>';
      } else if (gemaSencilla === 1) {
        icon = '<span class="icon-check">✓</span>';
      }
      
      // Tipo comisión: Sencilla o Especial
      let tipoText = '';
      if (tipoComision === 0.0075 || tipoComision === 0.00750) {
        tipoText = '<span class="tipo-sencilla">Sencilla</span>';
      } else if (tipoComision === 0.01 || tipoComision === 0.01000) {
        tipoText = '<span class="tipo-especial">Especial</span>';
      } else {
        tipoText = '<span class="tipo-sencilla">-</span>';
      }
      
      return `<tr>
        <td class="col-periodo">${periodo}</td>
        <td>${this.formatNum(row.A)}</td>
        <td>${this.formatNum(row.AA)}</td>
        <td>${this.formatNum(row.AA_dif)}</td>
        <td>${tipoText}</td>
        <td>${this.formatMoney(row.Comision)}</td>
        <td class="col-icon">${icon}</td>
      </tr>`;
    }).join('');
    
    this.updateNav();
  },
  
  updateNav() {
    const totalPages = Math.ceil(this.data.length / this.rowsPerPage);
    document.getElementById('brandPrevBtn').disabled = this.currentPage === 0;
    document.getElementById('brandNextBtn').disabled = this.currentPage >= totalPages - 1;
  },
  
  prevPage() { if (this.currentPage > 0) { this.currentPage--; this.render(); } },
  nextPage() { if (this.currentPage < Math.ceil(this.data.length / this.rowsPerPage) - 1) { this.currentPage++; this.render(); } },
  
  formatNum(v) { return new Intl.NumberFormat('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(parseFloat(v) || 0); },
  formatMoney(v) { return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(parseFloat(v) || 0); }
};

</script>
